_realname=python2
pkgbase=mingw-w64-${_realname}-prebuilt-win32
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}-prebuilt-win32"
pkgver=2.7.13
pkgrel=1
_pybasever=${pkgver%.*}
pkgdesc="A high-level scripting language (prebuilt; win32)"
arch=(i686 x86_64)
license=('PSF')
url="https://www.python.org/"
#makedepends=('wine')
options=('!staticlibs' 'strip')
source=(https://www.python.org/ftp/python/${pkgver}/python-${pkgver}$([ "${CARCH}" == x86_64 ] && echo .amd64).msi
        'python-config.sh'
        'python-config-u.sh'
        '0001-pyconfig-Disable-definition-of-hypot-as-_hypot.patch')
sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

build() {
  [[ -d ${srcdir}/build-${MINGW_CHOST} ]] && rm -rf ${srcdir}/build-${MINGW_CHOST}
  mkdir ${srcdir}/build-${MINGW_CHOST}

  msiexec /a python-${pkgver}*.msi /qb TARGETDIR=${srcdir}/build-${MINGW_CHOST}
}

package() {
  cd ${srcdir}/build-${MINGW_CHOST}

  patch -p1 -i ${srcdir}/0001-pyconfig-Disable-definition-of-hypot-as-_hypot.patch

  mkdir -p ${pkgdir}${PREFIX}/include
  cp -rT include ${pkgdir}${PREFIX}/include/python${_pybasever}

  mkdir -p ${pkgdir}${PREFIX}/bin
  cp -T python${_pybasever/./}.dll ${pkgdir}${PREFIX}/bin/python${_pybasever}.dll
  cp ${srcdir}/python-config*.sh ${pkgdir}${PREFIX}/bin/
  chmod a+x ${pkgdir}${PREFIX}/bin/*

  mkdir -p ${pkgdir}${PREFIX}/lib
  cp -rT Lib ${pkgdir}${PREFIX}/lib/python${_pybasever}
  mkdir -p ${pkgdir}${PREFIX}/lib/python${_pybasever}/config
  cp libs/libpython${_pybasever/./}.a ${pkgdir}${PREFIX}/lib/python${_pybasever}/config
  ln -sT ../../../bin/python${_pybasever}.dll ${pkgdir}${PREFIX}/lib/python${_pybasever}/config/python${_pybasever}.dll.a
}
