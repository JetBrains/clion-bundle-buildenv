# Eldar Abusalimov <Eldar.Abusalimov@jetbrains.com>
#
# This work is derived from the Arch Linux packaging project.
#
# Maintainer: Evangelos Foutras <evangelos@foutrelis.com>
# Contributor: Jan "heftig" Steffens <jan.steffens@gmail.com>
# Contributor: Sebastian Nowicki <sebnow@gmail.com>
# Contributor: Devin Cofer <ranguvar{AT]archlinux[DOT}us>
# Contributor: Tobias Kieslich <tobias@justdreams.de>
# Contributor: Geoffroy Carrier <geoffroy.carrier@aur.archlinux.org>
# Contributor: Tomas Lindquist Olsen <tomas@famolsen.dk>
# Contributor: Roberto Alsina <ralsina@kde.org>
# Contributor: Gerardo Exequiel Pozzi <vmlinuz386@yahoo.com.ar>

pkgname=lldb
pkgver=5.0.0
pkgrel=1
pkgdesc="Next generation, high-performance debugger"
arch=(i686 x86_64)
url="http://lldb.llvm.org/"
license=('custom:University of Illinois/NCSA Open Source License')
# makedepends=('cmake' 'libffi' 'python2' "ocaml=$_ocaml_ver" 'python-sphinx'
#              'ocaml-ctypes' 'ocaml-findlib' 'libedit' 'swig')
# depends=('llvm-libs' 'libxml2' 'python2' 'python2-six')
# depends=('gcc-libs' 'zlib' 'libffi' 'libedit' 'ncurses')
makedepends=('cmake' 'python' 'swig')
depends=(zlib)
options=(!debug)
source=(https://releases.llvm.org/${pkgver}/llvm-${pkgver}.src.tar.xz
        https://releases.llvm.org/${pkgver}/cfe-${pkgver}.src.tar.xz
        # https://releases.llvm.org/${pkgver}/clang-tools-extra-${pkgver}.src.tar.xz
        # https://releases.llvm.org/${pkgver}/compiler-rt-${pkgver}.src.tar.xz
        # https://releases.llvm.org/${pkgver}/lld-${pkgver}.src.tar.xz
        https://releases.llvm.org/${pkgver}/lldb-${pkgver}.src.tar.xz
        0500-disable-lldb-soname.patch)
sha256sums=('e35dcbae6084adcf4abb32514127c5eabd7d63b733852ccdb31e06f1373136da'
            '019f23c2192df793ac746595e94a403908749f8e0c484b403476d2611dd20970'
            'c0a0ca32105e9881d86b7ca886220147e686edc97fdb9f3657c6659dc6568b7d'
            '0001f7ff0268295fe67eb7b551670dc878eafa0c6e28c56b6aecc43deb4ec72d')

prepare() {
  cd "$srcdir/llvm-${pkgver}.src"
  mkdir build

  mv "$srcdir/cfe-${pkgver}.src" tools/clang
  mv "$srcdir/lldb-${pkgver}.src" tools/lldb

  cd tools/lldb
  patch -p1 -i "${srcdir}/0500-disable-lldb-soname.patch"

  # # https://bugs.llvm.org/show_bug.cgi?id=34123
  # sed -i '/LLVMSupport/d' tools/clang/tools/extra/clangd/tool/CMakeLists.txt
}

build() {
  cd "$srcdir/llvm-${pkgver}.src/build"

  cmake \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=${PREFIX} \
    -DPYTHON_EXECUTABLE=${PREFIX}/bin/python \
    -DLLVM_TARGETS_TO_BUILD="X86" \
    -DLLDB_DISABLE_LIBEDIT=TRUE \
    -DLLDB_DISABLE_CURSES=TRUE \
    ..

  make

  # # Disable automatic installation of components that go into subpackages
  # sed -i '/\(clang\|lld\|lldb\)\/cmake_install.cmake/d' tools/cmake_install.cmake
  # sed -i '/extra\/cmake_install.cmake/d' tools/clang/tools/cmake_install.cmake
  # sed -i '/compiler-rt\/cmake_install.cmake/d' projects/cmake_install.cmake
}

check() {
  cd "$srcdir/llvm-${pkgver}.src/build"
  make check-{llvm,clang}
}

package() {
  cd "$srcdir/llvm-${pkgver}.src"

  make -C build/tools/lldb DESTDIR="${pkgdir}" install

  # https://bugs.archlinux.org/task/50759
  sed -i "/import_module('_lldb')/s/_lldb/lldb.&/" \
    ${pkgdir}${PREFIX}/lib/python*/site-packages/lldb/__init__.py

  # # Remove bundled six library
  # rm "${pkgdir}${PREFIX}/lib/python2.7/site-packages/six.py"

  # # Compile Python scripts
  # python2 -m compileall "${pkgdir}${PREFIX}/lib/python2.7/site-packages/lldb"
  # python2 -O -m compileall "${pkgdir}${PREFIX}/lib/python2.7/site-packages/lldb"

  install -Dm644 LICENSE.TXT "${pkgdir}${PREFIX}/share/licenses/llvm/LICENSE"
  install -Dm644 tools/${pkgname}/LICENSE.TXT "${pkgdir}${PREFIX}/share/licenses/${pkgname}/LICENSE"
}
