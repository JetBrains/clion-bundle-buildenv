# Eldar Abusalimov <Eldar.Abusalimov@jetbrains.com>

_realname=python3
pkgname=${_realname}-embed
pkgver=3.12.9
pkgrel=1
_pybasever=${pkgver%.*}
pkgdesc="A high-level scripting language (prebuilt; win32)"
arch=(aarch64 i686 x86_64)
license=('PSF')
url="https://www.python.org/"
options=('!staticlibs' '!strip')

if [ "${CARCH}" == aarch64 ]; then
  _archsuffix=arm64; _embed_zip_md5='b5c1583bb0dc258799570a57a31a269d'
elif [ "${CARCH}" == x86_64 ]; then
  _archsuffix=amd64; _embed_zip_md5='f34996cc1f44c98729ef6ce92d05e41c'
else
  _archsuffix=win32; _embed_zip_md5='a8015f8d166ea9a1fa9a3cf3b26c958d'
fi

source=(https://www.python.org/ftp/python/${pkgver}/Python-${pkgver}.tar.xz
        https://www.python.org/ftp/python/${pkgver}/python-${pkgver}-embed-${_archsuffix}.zip
        'python-config.sh.in')
noextract=(python-${pkgver}-embed-${_archsuffix}.zip)
md5sums=('880942124f7d5c01e7b65cbad62dc873'
         "${_embed_zip_md5}"
         'a83b453497b1c994271cdcdd91641ef3')

prepare() {
  cat python-config.sh.in | sed -e "
    s|@prefix@|${PREFIX//|/\\|}|g
    s|@CFLAGS@|${CFLAGS//|/\\|}|g
    s|@VERSION@|${_pybasever}|g
  " > python-config.sh

  cd Python-${pkgver}
}

build() {
  [[ -d ${srcdir}/build-${CHOST} ]] && rm -rf ${srcdir}/build-${CHOST}
  mkdir ${srcdir}/build-${CHOST}

  (cd ${srcdir}/build-${CHOST}; bsdtar -xf ${srcdir}/python-${pkgver}-embed-${_archsuffix}.zip)
}

package() {
  cd ${srcdir}/build-${CHOST}

  install -dm755 ${pkgdir}${PREFIX}/include/python${_pybasever}
  install -dm755 ${pkgdir}${PREFIX}/bin/python${_pybasever}
  install -dm755 ${pkgdir}${PREFIX}/lib/python${_pybasever}

  cp -r ${srcdir}/Python-${pkgver}/Include/* ${pkgdir}${PREFIX}/include/python${_pybasever}

  install -Dm644 -t ${pkgdir}${PREFIX}/include/python${_pybasever} ${srcdir}/Python-${pkgver}/PC/pyconfig.h
  install -Dm644 -t ${pkgdir}${PREFIX}/bin/ python${_pybasever/./}.zip *._pth
  install -Dm755 -t ${pkgdir}${PREFIX}/bin/ *.{dll,pyd,exe} ${srcdir}/python-config.sh

  install -dm755 ${pkgdir}${PREFIX}/lib/python${_pybasever}/config
  ln -sT ../../../bin/python${_pybasever/./}.dll ${pkgdir}${PREFIX}/lib/python${_pybasever}/config/python${_pybasever}.dll.a
}
